name: Build
on: 
   push:
      # ç”±äºå…¶å®ƒåˆ†æ”¯ä¸ºæœ¬åœ°æµ‹è¯•æ‰“åŒ…ï¼Œæ•…åª CI ä¸»çº¿å˜æ›´
      branches: [ wu_main ]
      paths-ignore: 
       - '**.md'
       - '**.txt'
       - '.github/**'
       - '!.github/workflows/**'
jobs:
   setup:
    name: Setup Project Info
    runs-on: ubuntu-latest
    outputs:
       DIST_SUFFIX: ${{ steps.get-suffix.outputs.DIST_SUFFIX }}
    steps: 
     - name: ğŸ§ Checkout
       id: checkout
       uses: actions/checkout@v4
       with: 
          fetch-depth: '0'

     - name: ğŸ“™ Get Package Suffix
       id: get-suffix
       run: |
         # æ­¤å¤„é€šè¿‡ jq ä» package.json è·å–ç‰ˆæœ¬ï¼Œå¦åˆ™åœ¨ depth 
         # ä¸º 1 æ—¶é€šè¿‡ git tag æ‰€è¯»å–çš„ç‰ˆæœ¬ä¸å‡†ç¡®
         sudo apt-get install jq
         VERSION=$(jq -r '.version' ./package.json)
         
         COMMIT_COUNT=$(git rev-list --count HEAD)
         BUILD_DATE=$(date "+%y%m%d")
         HEAD_SHA=$(git rev-parse --short HEAD)
         echo "DIST_SUFFIX=v${VERSION}-${COMMIT_COUNT}-${BUILD_DATE}-${HEAD_SHA}" >> $GITHUB_OUTPUT

   build:
      name: Build Production Page
      needs: setup
      env:
         DIST_NAME: dist-${{ needs.setup.outputs.DIST_SUFFIX }}
      runs-on: ubuntu-latest
      steps:
       - name: ğŸ§ Checkout
         id: checkout
         uses: actions/checkout@v4
         with: 
            fetch-depth: '1'

       - name: ğŸ› ï¸ Setup environment
         id: setup
         uses: pnpm/action-setup@v3
         with:
            version: 8

       - name: âš™ï¸ Build production pages
         id: build
         run: |
            pnpm install
            pnpm add @vue/cli
            pnpm build

       - name: ğŸŒ Upload the build
         id: upload
         uses: actions/upload-artifact@v4
         with:
             name: ${{ env.DIST_NAME }}
             path: dist
